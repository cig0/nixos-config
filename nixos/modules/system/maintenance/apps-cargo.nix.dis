# Systemd timer that runs a service to upgrade Cargo packages defined in $HOME/.config/apps.cargo weekly.

# home-manager/modules/maintenance/apps-cargo.nix
{ pkgs, ... }:

{
  systemd.user = {
    services.cargo-upgrade = {
      Description = "Upgrade Cargo packages";

      After = [ "network-online.target" ];
      Wants = [ "network-online.target" ];

      Unit = {
        Description = "Upgrade Cargo packages";
      };

      Service = {
        Type = "oneshot";
        Environment = "XDG_CONFIG_HOME=%h/.config";
        ExecStart = "${pkgs.zsh}/bin/zsh -c 'source /etc/zshrc && _upgrade-apps-cargo'";
        Restart = "no";
        ProtectSystem = "strict";
        ProtectHome = "no";
        NoNewPrivileges = true;
      };

      Install = {
        WantedBy = [ "default.target" ];
      };
    };

    timers.cargo-upgrade = {
      Unit = {
        Description = "Timer for Cargo packages upgrade";
      };

      Timer = {
        OnCalendar = "weekly";
        Persistent = true;
        RandomizedDelaySec = "45min";
        OnBootSec = "15min";
        OnUnitActiveSec = "1w";
      };

      Install = {
        WantedBy = [ "timers.target" ];
      };
    };
  };
}